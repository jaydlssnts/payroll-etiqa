@using System.Diagnostics.Eventing.Reader
@using payroll.model
@model payroll.model.Employee
@{
    Layout = "_Layout";
}
@{
    <h2 class="text-center">Details</h2>
    <div class="mt-3 d-flex flex-row justify-content-between py-2">
    <a class="btn btn-info" href="@Url.Action("Index", "Employee")">Back</a>
    <a class="btn btn-success" href="@Url.Action("Index", "Employee")">Calculate Take Home Pay</a>
    </div>
    <table class="table table-striped table-primary table-bordered">
        <thead class="table-dark">
            <tbody>
                <tr>
                    <td>Name</td>
                    <td>@Model.EmployeeName</td>
                </tr>
                <tr>
                    <td>ID Number</td>
                    <td>@Model.EmployeeNumber</td>
                </tr>
                <tr>
                    <td>BirthDate</td>
                    <td>@Model.BirthDate</td>
                </tr>
                <tr>
                    <td>Daily Rate</td>
                    <td><span>₱</span>@Model.DailyRate</td>
                </tr>
                <tr>
                    <td>Working Schedule</td>
                    @if(@Model.WorkSchedule == WorkSchedule.MWF){
                        <td>Monday, Wednesday, Friday</td>
                    }
                    else{
                        <td>Tuesday, Thursday, Saturday</td>
                    }
                </tr>
            </tbody>
        <tbody>        
    </table>

    <div class="mt-3 d-flex flex-row justify-content-between">
        <a href="/Employee/Edit/@Model.EmployeeNumber" class="btn btn-warning">Edit</a>
        <button type="button" class="btn btn-danger" 
                onclick="deleteEmployee('@Model.EmployeeNumber')">
            Delete Employee
        </button>
    </div>
    
    <script>
    async function deleteEmployee(id) {
        if (confirm("Are you sure you want to delete this employee?")) {
            try {
                // Adjust the URL to match your API route
                const response = await fetch(`/api/employees/${id}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    alert("Employee deleted successfully.");
                    // Redirect back to the index page
                    window.location.href = '@Url.Action("Index", "Employee")';
                } else {
                    const error = await response.text();
                    alert("Error deleting employee: " + error);
                }
            } catch (err) {
                console.error("Failed to call API:", err);
                alert("An error occurred while trying to delete.");
            }
        }
    }
</script>
<form id="takeHomePayForm" class="row g-3">
    <div class="col-md-4">
        <label for="startDate" class="form-label">Start Date</label>
        <input type="date" class="form-control" id="startDate" required />
    </div>
    <div class="col-md-4">
        <label for="endDate" class="form-label">End Date</label>
        <input type="date" class="form-control" id="endDate" required />
    </div>
    <div class="col-md-4 align-self-end">
        <button type="button" id="calculatePay" class="btn btn-success">Calculate</button>
        <button type="reset" class="btn btn-secondary">Cancel</button>
    </div>
</form>

<div id="takeHomePayResult" class="mt-3"></div>
<script>
    document.getElementById("calculatePay").addEventListener("click", function () {
        const start = new Date(document.getElementById("startDate").value);
        const end = new Date(document.getElementById("endDate").value);

        if (isNaN(start) || isNaN(end) || start > end) {
            alert("Please enter a valid date range.");
            return;
        }

        // Employee data from Razor
        const dailyRate = parseFloat("@Model.DailyRate");
        const birthDate = new Date("@Model.BirthDate.ToString("yyyy-MM-dd")");

        // Map work schedule to weekdays
        const workDays = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.WorkSchedule == payroll.model.WorkSchedule.MWF ? new[] { "Mon", "Wed", "Fri" } : new[] { "Tue", "Thu", "Sat" }
        ));

        let totalPay = 0;

        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });

            const isBirthday = (d.getDate() === birthDate.getDate() && d.getMonth() === birthDate.getMonth());

            if (isBirthday) {
                totalPay += dailyRate; // 100% daily rate
            }

            if (workDays.includes(dayName)) {
                totalPay += dailyRate * 2; // twice daily rate on workday
            }
        }

        document.getElementById("takeHomePayResult").innerHTML =
            `<div class="alert alert-info">Take-Home Pay: ₱${totalPay.toFixed(2)}</div>`;
    });
</script>
}